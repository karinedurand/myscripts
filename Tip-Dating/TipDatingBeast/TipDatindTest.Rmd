---
title: "TipDating"
author: "karine Durand"
date: "9 avril 2019"
output:
  word_document: default
  pdf_document: default
  html_document: default
---
Then launch TipDatingBEAST:

```{r setup, include=FALSE}
library(TipDatingBeast)
setwd("/home/kadurand/partage_windows/Xylella/analyses_genomiques/ABC/myscripts/Tip-Dating/TipDatingBeast/")
```

##3.3 Functions related to the "Date-randomized test"

The "RandomDates" function reads an XML-formatted input file, randomly shuffles the
dates (sequence ages) between all samples and writes a new date-randomized-XML. In
TipDatingBeast, this function should be called with the following command:


```{r cars}
RandomDates(name="/home/kadurand/partage_windows/Xylella/analyses_genomiques/ABC/myscripts/Tip-Dating/TipDatingBeast/example/Flu_BEAST_18",reps=20)
```

## 3.3.2 The "RandomCluster" function

3.3.2 The "RandomCluster" function
This function is similar to "RandomDates" excepts that in "RandomCluster", samples are
grouped into clusters and the shuffling procedure randomizes dates among the clusters but
not within (see Duchêne et al. 2015) for more details on this procedure). There are two
distinct ways to group the samples into clusters. The first one is through the upload of a
.csv file containing the names of the samples (as given in the XML) and a cluster number.
Any positive integer (i.e., positive number) can be used to identified cluster; if a "0" is given
to any sample, it would be excluded from the procedure (refer to Duchêne et al. 2015) for a
explanation of when such approach could be required). The file containing the
classification should be labeled: clusters."name".cvs. An example for such a file in the case
of the Influenza dataset can be found distributed with the package. This function allows
performing date-randomization amongst ancient samples only, if necessary. To do so, the
user needs to set the group identifier for the ancient sample to “1” while assigning a “0” to
the modern samples
In a second approach, a model-based clustering classification is automatically performed
using the mclust library (Fraley & Raftery 2002). In this case, the option loadCluster should
be set to FALSE (loadCluster = F). If this option is chosen, the new classification is writ

```{r pressure}
RandomCluster(name="/home/kadurand/partage_windows/Xylella/analyses_genomiques/ABC/myscripts/Tip-Dating/TipDatingBeast/example/Flu_BEAST_232",reps=20,loadCluster=T)
```

# 3.3.3 The "PlotDRT" function
Once analyzed with BEAST, the PlotDRT function allows comparing the parameter
estimates obtained with the original vs. the randomized datasets. This function requires
uploading, reading and analyzing the "Log" files generated by BEAST. A Log file contains a
row for each MCMC sampling and a column for each estimated parameter. When
considered as frequency distributions, this file provides an estimate of the marginal
posterior probability distribution for each parameter. The function "PlotDRT" enable a
graphical comparison of the parameter estimates obtained with the original vs. the date-
randomized datasets (whatever the shuffling procedure considered).In TipDatingBeast:
This means that you should indicate which parameter of the log files you want the DRT to
be performed on. You generally have the choice between using the rate of evolution or the
age of the root. To select a variable, type VAR and hit enter:
enter parameter, type VAR to list variable names

The list of parameter extracted from the log file should appear. Let say you want the DRT to
be performed on the rate of evolution (noted clock.rate), then type clock.rate
```{r}
PlotDRT(name="/home/kadurand/partage_windows/Xylella/analyses_genomiques/ABC/myscripts/Tip-Dating/TipDatingBeast/RDT Logs/Flu_BEAST_18",reps=10,burnin=0.1)
```

This plot, often called the DRT is fairly straightforward to interpret. If the 95%HPD of the
rate of evolution (or of the age of the root) calculated on the real dataset (in red) do not
overlap with any of the ones on the date-randomized datasets (in black) as above, then the
DRT is passed and tip-dating inferences can thoroughly be performed on the real dataset. If
this is not the case, then the temporal signal in the data set is probably not wide enough to
perform tip-dating inferences.

##3.4 Functions related to the Leave-one-out-cross-validation
The Leave-one-out-cross-validation (hereafter LOOCV) is a statistical procedure aiming to
detect whether some particular sequences, when used as calibration in a tip dating
analyses, could lead to systematic bias.
For a dataset of n taxa, the LOOCV involves i) generating n XML-formatted input files, each
of them excluding one taxa, ii) running BEAST with each new input file and estimate the age
of the missing taxa using all the other ones and iii) comparing the estimated vs. true
sequence ages.
#3.4.1 The "TaxaOut" function
The function "TaxaOut" allow generating as many XML-formatted input files as a dataset
contains taxa and estimating. Those new XMLs are modified to, when ran in BEAST, provide
an estimation of the age of the missing taxa using the calibrations of the other ones. In R:
```{r}
TaxaOut(name="/home/kadurand/partage_windows/Xylella/analyses_genomiques/ABC/myscripts/Tip-Dating/TipDatingBeast/example/Flu_BEAST_18",lBound=0.0, hBound=1.E100)
```

The above command reads the Flu-BEAST-18.xml and generates 21 new XMLs, each of
them excluding one different taxa from the tip-calibration panel. Note that the name of the
xml can be anything and does not have to include the version of BEAST (it is the case here
but it is not mandatory). The new XMLs for the LOOCV procedure are automatically
labeled: "name".Taxon[i].xml where i is the number of the taxon being excluded.
Note: in case bounds are manually set up through the lBound and hBound arguments, ages of
the samples should be within (and not on the boundaries of) the range of the age prior used. If
not the case, it is possible that BEAST stalls.
#3.4.2 The "listTaxa" and "TaxonOut" functions
The function "TaxonOut" does the same thing as "TaxaOut" but one one specific Taxon
Here is an example with the Influenza dataset for BEAST 1.x, specifying the name of the
taxon (HUMAN_VIETNAM_CL105_2005) to be excluded from the tip-calibration panel and
for which the age should be estimated using the other taxa.

```{r}
TaxonOut(name="Flu_BEAST_18",lBound=0.0,hBound=1.E100,takeOut= "/home/kadurand/partage_windows/Xylella/analyses_genomiques/ABC/myscripts/Tip-Dating/TipDatingBeast/example/HUMAN_VIETNAM_CL105_2005")
```

#3.4.3 The "PlotLOOCV" function
Once the XMLs produced with the "TaxaOut" function analyzed with BEAST, the PlotLOOCV
function allows a graphical comparison of the estimated vs "true" sequence ages. Similarly
to the PlotDRT function, PlotLOOCV requires uploading, reading and analysing the "Log"
files generated by BEAST.

```{r}
PlotLOOCV("/home/kadurand/partage_windows/Xylella/analyses_genomiques/ABC/myscripts/Tip-Dating/TipDatingBeast/LOOCV logs/Flu_BEAST_18",burnin=0.1)
```
This plot is also fairly straightforward to interpret. Particular attention should be paid to
the sequences for which "real" ages are not included into the estimated interval (see Rieux
& Khatchikian 2017) for a discussion on the reasons and the consequences of such a
deviation).
